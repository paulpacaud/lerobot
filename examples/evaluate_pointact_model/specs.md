Plan: PointAct Robot Client                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                    
 Create a new standalone robot client that preprocesses observations to PointAct format and sends them via HTTP POST with msgpack serialization to a PointAct-specific policy server.                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                    
 Overview                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                    
 This is a new client script, not a modification of the existing robot_client.py. The PointAct format requires:                                                                                                                                                                                                                                                                     
 - State in EE-space (not joint-space): observation.state = [x, y, z, axis_angle1, axis_angle2, axis_angle3, gripper]                                                                                                                                                                                                                                                               
 - Images resized to 256x256                                                                                                                                                                                                                                                                                                                                                        
 - Point clouds from depth images                                                                                                                                                                                                                                                                                                                                                   
 - msgpack serialization (not pickle)                                                                                                                                                                                                                                                                                                                                               
 - HTTP/REST protocol (not gRPC) - simple POST requests                                                                                                                                                                                                                                                                                                                             
 - Different batch format with lists per key                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                    
 Files to Create                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                    
 1. /home/prl-tiago/lerobot/src/lerobot/async_inference/pointact_robot_client.py                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                    
 New standalone script that:                                                                                                                                                                                                                                                                                                                                                        
 - Collects observations from robot (joint positions, RGB, depth)                                                                                                                                                                                                                                                                                                                   
 - Converts joint positions to EE pose via FK                                                                                                                                                                                                                                                                                                                                       
 - Generates point clouds from depth images                                                                                                                                                                                                                                                                                                                                         
 - Resizes images to 256x256                                                                                                                                                                                                                                                                                                                                                        
 - Packs data into PointAct batch format                                                                                                                                                                                                                                                                                                                                            
 - Serializes with msgpack and sends via HTTP POST to server                                                                                                                                                                                                                                                                                                                        
 - Receives EE-space actions (msgpack response) and converts to joints via IK                                                                                                                                                                                                                                                                                                       
 - Uses requests library for HTTP communication                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                    
 2. /home/prl-tiago/lerobot/src/lerobot/async_inference/pointact_configs.py                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                    
 New config class PointActClientConfig with fields:                                                                                                                                                                                                                                                                                                                                 
 - server_address: str - Policy server address                                                                                                                                                                                                                                                                                                                                      
 - urdf_path: str - Path to URDF for FK/IK                                                                                                                                                                                                                                                                                                                                          
 - target_frame: str = "gripper_frame_link" - EE frame name                                                                                                                                                                                                                                                                                                                         
 - translation_offset: list[float] - [tx, ty, tz] offset (default: [-0.2755, -0.0599, 0.0257])                                                                                                                                                                                                                                                                                      
 - image_size: int = 256 - Target image size                                                                                                                                                                                                                                                                                                                                        
 - source_image_key: str = "front" - Camera key                                                                                                                                                                                                                                                                                                                                     
 - joint_names: list[str] - Joint names for FK                                                                                                                                                                                                                                                                                                                                      
 - intrinsics_file: str - Path to camera intrinsics .npz                                                                                                                                                                                                                                                                                                                            
 - extrinsics_file: str - Path to camera extrinsics .npz                                                                                                                                                                                                                                                                                                                            
 - voxel_size: float = 0.01 - Voxel size for point cloud                                                                                                                                                                                                                                                                                                                            
 - workspace: dict - Workspace bounds for cropping                                                                                                                                                                                                                                                                                                                                  
 - repo_id: str - Model repository ID                                                                                                                                                                                                                                                                                                                                               
 - fps: int = 30 - Control frequency                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                    
 3. /home/prl-tiago/lerobot/src/lerobot/async_inference/pointact_utils.py                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                    
 Utility functions for PointAct preprocessing:                                                                                                                                                                                                                                                                                                                                      
 - joints_to_ee() - FK conversion                                                                                                                                                                                                                                                                                                                                                   
 - depth_to_point_cloud() - Point cloud generation                                                                                                                                                                                                                                                                                                                                  
 - crop_point_cloud_by_workspace() - Workspace cropping                                                                                                                                                                                                                                                                                                                             
 - voxelize_point_cloud() - Open3D voxelization                                                                                                                                                                                                                                                                                                                                     
 - resize_image() - Image resizing                                                                                                                                                                                                                                                                                                                                                  
 - pack_pointact_batch() - Create batch dict and serialize with msgpack                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                    
 Implementation Details                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                    
 FK Conversion (from convert_to_pointact_format.py)                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                    
 def _joints_to_ee(joint_values, kinematics, translation_offset):                                                                                                                                                                                                                                                                                                                   
     arm_joints = joint_values[:5]  # Exclude gripper                                                                                                                                                                                                                                                                                                                               
     gripper_pos = joint_values[5]                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                    
     T = kinematics.forward_kinematics(arm_joints)                                                                                                                                                                                                                                                                                                                                  
     position = T[:3, 3] + translation_offset                                                                                                                                                                                                                                                                                                                                       
     rotation_vec = Rotation.from_matrix(T[:3, :3]).as_rotvec()                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                    
     ee_pose = [*position, *rotation_vec]  # 6D                                                                                                                                                                                                                                                                                                                                     
     ee_pose_with_gripper = [*ee_pose, gripper_pos]  # 7D                                                                                                                                                                                                                                                                                                                           
     return ee_pose, ee_pose_with_gripper                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                    
 Output Observation Keys                                                                                                                                                                                                                                                                                                                                                            
 ┌──────────────────────────────────┬───────────────┬────────────────────────────────┐                                                                                                                                                                                                                                                                                              
 │               Key                │     Shape     │          Description           │                                                                                                                                                                                                                                                                                              
 ├──────────────────────────────────┼───────────────┼────────────────────────────────┤                                                                                                                                                                                                                                                                                              
 │ observation.state                │ (7,)          │ EE pose + gripper              │                                                                                                                                                                                                                                                                                              
 ├──────────────────────────────────┼───────────────┼────────────────────────────────┤                                                                                                                                                                                                                                                                                              
 │ observation.states.ee_state      │ (6,)          │ EE pose only                   │                                                                                                                                                                                                                                                                                              
 ├──────────────────────────────────┼───────────────┼────────────────────────────────┤                                                                                                                                                                                                                                                                                              
 │ observation.states.joint_state   │ (6,)          │ Original joint positions       │                                                                                                                                                                                                                                                                                              
 ├──────────────────────────────────┼───────────────┼────────────────────────────────┤                                                                                                                                                                                                                                                                                              
 │ observation.states.gripper_state │ (1,)          │ Gripper only                   │                                                                                                                                                                                                                                                                                              
 ├──────────────────────────────────┼───────────────┼────────────────────────────────┤                                                                                                                                                                                                                                                                                              
 │ observation.images.front_image   │ (256, 256, 3) │ Resized RGB image              │                                                                                                                                                                                                                                                                                              
 ├──────────────────────────────────┼───────────────┼────────────────────────────────┤                                                                                                                                                                                                                                                                                              
 │ observation.points.frontview     │ (N, 6)        │ Point cloud [x, y, z, r, g, b] │                                                                                                                                                                                                                                                                                              
 └──────────────────────────────────┴───────────────┴────────────────────────────────┘                                                                                                                                                                                                                                                                                              
 Point Cloud Processing                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                    
 Point clouds will be generated from depth images using camera intrinsics/extrinsics:                                                                                                                                                                                                                                                                                               
 - Requires depth camera enabled: use_depth: true in camera config                                                                                                                                                                                                                                                                                                                  
 - Uses existing calibration from examples/post_process_dataset/constants/                                                                                                                                                                                                                                                                                                          
 - Cropped to workspace bounds and optionally voxelized                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                    
 The processing pipeline (from add_point_cloud_to_dataset.py):                                                                                                                                                                                                                                                                                                                      
 def get_point_cloud_from_rgb_depth(rgb, depth, intrinsics, extrinsics, workspace, voxel_size):                                                                                                                                                                                                                                                                                     
     # 1. Convert depth image to 3D points in world coordinates                                                                                                                                                                                                                                                                                                                     
     point_cloud_xyz = depth_to_point_cloud(depth, intrinsics, extrinsics)                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                    
     # 2. Combine with RGB colors (normalized to 0-1)                                                                                                                                                                                                                                                                                                                               
     rgb_normalized = rgb.astype(np.float32) / 255.0                                                                                                                                                                                                                                                                                                                                
     point_cloud = np.concatenate([point_cloud_xyz, rgb_normalized], axis=2)                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                    
     # 3. Filter invalid depth points (z > 0)                                                                                                                                                                                                                                                                                                                                       
     valid_mask = point_cloud[:, 2] > 0                                                                                                                                                                                                                                                                                                                                             
     point_cloud = point_cloud[valid_mask]                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                    
     # 4. Crop to workspace bounds                                                                                                                                                                                                                                                                                                                                                  
     point_cloud = crop_point_cloud_by_workspace(point_cloud, workspace)                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                    
     # 5. Voxelize using Open3D                                                                                                                                                                                                                                                                                                                                                     
     point_cloud = voxelize_point_cloud(point_cloud[:, :3], point_cloud[:, 3:], voxel_size)                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                    
     return point_cloud  # Shape: (N, 6) [x, y, z, r, g, b]                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                    
 Default workspace bounds (from constants/constants.py):                                                                                                                                                                                                                                                                                                                            
 WORKSPACE = {                                                                                                                                                                                                                                                                                                                                                                      
     'X_BBOX': [-0.21, 0.23],   # Forward-backward                                                                                                                                                                                                                                                                                                                                  
     'Y_BBOX': [-0.35, 0.3],    # Left-right                                                                                                                                                                                                                                                                                                                                        
     'Z_BBOX': [0.025, 0.4],    # Up-down (above table)                                                                                                                                                                                                                                                                                                                             
 }                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                    
 Usage Example                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                    
 python -m lerobot.async_inference.pointact_robot_client \                                                                                                                                                                                                                                                                                                                          
   --server_address=127.0.0.1:8080 \                                                                                                                                                                                                                                                                                                                                                
   --robot.type=so100_follower \                                                                                                                                                                                                                                                                                                                                                    
   --robot.port=/dev/ttyACM0 \                                                                                                                                                                                                                                                                                                                                                      
   --robot.id=follower_arm \                                                                                                                                                                                                                                                                                                                                                        
   --robot.cameras="{ front: {type: intelrealsense, serial_number_or_name: 147122078460, width: 640, height: 480, fps: 30, use_depth: true}}" \                                                                                                                                                                                                                                     
   --task="put the cube in the green square spot" \                                                                                                                                                                                                                                                                                                                                 
   --urdf_path=./URDF/SO101/so101_new_calib.urdf \                                                                                                                                                                                                                                                                                                                                  
   --translation_offset="[-0.2755, -0.0599, 0.0257]" \                                                                                                                                                                                                                                                                                                                              
   --intrinsics_file=./examples/post_process_dataset/constants/intrinsics.npz \                                                                                                                                                                                                                                                                                                     
   --extrinsics_file=./examples/post_process_dataset/constants/extrinsics.npz \                                                                                                                                                                                                                                                                                                     
   --repo_id=user/pointact_model \                                                                                                                                                                                                                                                                                                                                                  
   --fps=30                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                    
 Batch Format & Serialization                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                    
 The observation batch should be structured as follows and serialized with msgpack:                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                    
 batch = {                                                                                                                                                                                                                                                                                                                                                                          
     "observation.images.front_image": [obs["observation.images.front_image"]],  # List of (256, 256, 3) arrays                                                                                                                                                                                                                                                                     
     "observation.points": [point_cloud],  # List of (N, 6) arrays                                                                                                                                                                                                                                                                                                                  
     "observation.state": [state],  # List of (7,) arrays [x, y, z, ax1, ax2, ax3, gripper]                                                                                                                                                                                                                                                                                         
     "task": [obs["task"]],  # List of task strings                                                                                                                                                                                                                                                                                                                                 
     "repo_id": [args.repo_id],  # List of repo_id strings (for model identification)                                                                                                                                                                                                                                                                                               
 }                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                    
 # Serialize with msgpack                                                                                                                                                                                                                                                                                                                                                           
 import msgpack                                                                                                                                                                                                                                                                                                                                                                     
 import msgpack_numpy                                                                                                                                                                                                                                                                                                                                                               
 msgpack_numpy.patch()                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                    
 observation_bytes = msgpack.packb(batch)                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                    
 This format:                                                                                                                                                                                                                                                                                                                                                                       
 - Uses lists for batching (even for single observations)                                                                                                                                                                                                                                                                                                                           
 - Includes repo_id for model identification                                                                                                                                                                                                                                                                                                                                        
 - Uses msgpack with numpy support for efficient serialization                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                    
 Data Flow                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                    
 Robot → get_observation() → Joint-space obs + RGB + Depth                                                                                                                                                                                                                                                                                                                          
                                ↓                                                                                                                                                                                                                                                                                                                                                   
                     PointAct Preprocessing                                                                                                                                                                                                                                                                                                                                         
                                ↓                                                                                                                                                                                                                                                                                                                                                   
                     1. FK: joints → EE pose (state)                                                                                                                                                                                                                                                                                                                                
                     2. Resize RGB to 256x256                                                                                                                                                                                                                                                                                                                                       
                     3. Depth + RGB → Point cloud (voxelized)                                                                                                                                                                                                                                                                                                                       
                     4. Pack into batch dict                                                                                                                                                                                                                                                                                                                                        
                     5. Serialize with msgpack                                                                                                                                                                                                                                                                                                                                      
                                ↓                                                                                                                                                                                                                                                                                                                                                   
                     HTTP POST (msgpack body) → PointAct Policy Server                                                                                                                                                                                                                                                                                                              
                                ↓                                                                                                                                                                                                                                                                                                                                                   
                     HTTP Response (msgpack) ← EE-space actions                                                                                                                                                                                                                                                                                                                     
                                ↓                                                                                                                                                                                                                                                                                                                                                   
                     IK: EE → joints                                                                                                                                                                                                                                                                                                                                                
                                ↓                                                                                                                                                                                                                                                                                                                                                   
                     Robot executes joint commands                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                    
 Verification                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                    
 1. Run pointact_robot_client.py with the required arguments                                                                                                                                                                                                                                                                                                                        
 2. Check logs confirm FK processor and point cloud processor are initialized                                                                                                                                                                                                                                                                                                       
 3. Verify HTTP requests are sent with correct msgpack body                                                                                                                                                                                                                                                                                                                         
 4. Test with a mock server that echoes the received batch format                                                                                                                                                                                                                                                                                                                   
 5. Test full inference loop with a PointAct-trained model and real robot                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                    
 Dependencies                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                    
 - placo - For forward kinematics (already used for IK)                                                                                                                                                                                                                                                                                                                             
 - open3d - For point cloud voxelization (optional but recommended)                                                                                                                                                                                                                                                                                                                 
 - scipy - For rotation conversions (Rotation.from_matrix)                                                                                                                                                                                                                                                                                                                          
 - msgpack + msgpack-numpy - For efficient batch serialization                                                                                                                                                                                                                                                                                                                      
 - requests - For HTTP communication with policy server                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                    
 File Summary                                                                                                                                                                                                                                                                                                                                                                       
 ┌──────────────────────────────────────────────────────┬────────┬──────────────────────────────────────────────┐                                                                                                                                                                                                                                                                   
 │                         File                         │ Action │                 Description                  │                                                                                                                                                                                                                                                                   
 ├──────────────────────────────────────────────────────┼────────┼──────────────────────────────────────────────┤                                                                                                                                                                                                                                                                   
 │ src/lerobot/async_inference/pointact_robot_client.py │ Create │ Main PointAct client script                  │                                                                                                                                                                                                                                                                   
 ├──────────────────────────────────────────────────────┼────────┼──────────────────────────────────────────────┤                                                                                                                                                                                                                                                                   
 │ src/lerobot/async_inference/pointact_configs.py      │ Create │ Config dataclass for PointAct client         │                                                                                                                                                                                                                                                                   
 ├──────────────────────────────────────────────────────┼────────┼──────────────────────────────────────────────┤                                                                                                                                                                                                                                                                   
 │ src/lerobot/async_inference/pointact_utils.py        │ Create │ FK, point cloud, and batch packing utilities │                                                                                                                                                                                                                                                                   
 └──────────────────────────────────────────────────────┴────────┴──────────────────────────────────────────────┘ 
 




# usage

`ssh -N -v -L 17000:gpu017:17000 ppacaud@cleps.inria.fr`

```bash
python -m lerobot.async_inference.pointact_robot_client --server_address=localhost:17000 --robot.type=so100_follower --robot.port=/dev/ttyACM0 --robot.id=follower_arm --robot.cameras="{ front: {type: intelrealsense, serial_number_or_name: 147122078460, width: 640, height: 480, fps: 30, use_depth: true}}" --urdf_path=./examples/post_process_dataset/constants/SO101/so101_new_calib.urdf --intrinsics_file=./examples/post_process_dataset/constants/intrinsics.npz --extrinsics_file=./examples/post_process_dataset/constants/extrinsics.npz --task="put the banana in the blue plate, then put the green toy in the pink plate" --repo_id=put_banana_and_toy_in_plates_pointact --fps=30 --debug_dir=$HOME/lerobot_datasets/debug_logs
```

# fake server


# Terminal 1: Start fake server                                                                                                                                                                                                                                                                                                                                                   
  python -m lerobot.async_inference.fake_pointact_server --port=17000                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                    
  # Terminal 2: Run client with debug logging                                                                                                                                                                                                                                                                                                                                       
  python -m lerobot.async_inference.pointact_robot_client --server_address=localhost:17000 --debug_dir=./debug_logs ...                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                    
  # Terminal 3: Visualize saved session                                                                                                                                                                                                                                                                                                                                             
  python -m lerobot.async_inference.visualize_debug_session --session_dir=./debug_logs/session_20260129_143052 --frame=0 --interactive 
